
<!DOCTYPE html>

<html>
    <head>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />

        <title> Listar Categorias</title>
        <script type="text/javascript">

            // Váriavel para o objecto XMLHttpRequest
            var xmlHttpObj;

            function CreateXmlHttpRequestObject( )
            {
                // detecção do browser simplificada
                // e sem tratamento de excepções
                xmlHttpObj = null;
                if (window.XMLHttpRequest) // IE 7 e Firefox
                {
                    xmlHttpObj = new XMLHttpRequest()

                }
                else if (window.ActiveXObject) // IE 5 e 6
                {
                    xmlHttpObj = new ActiveXObject("Microsoft.XMLHTTP")
                }
                return xmlHttpObj;
            }

            function carregarCategorias()
            {
                xmlHttpObj = CreateXmlHttpRequestObject();

                if (xmlHttpObj)
                {
                    // Definição do URL para efectuar pedido HTTP - método GET
                    xmlHttpObj.open("GET", "selectCategorias.php", true);


                    // Registo do EventHandler
                    xmlHttpObj.onreadystatechange = stateHandler;

                    xmlHttpObj.send(null);
                }

            }

            function stateHandler()
            {
                if (xmlHttpObj.readyState == 4 && xmlHttpObj.status == 200) // resposta do servidor completa
                {
                    //alert(xmlHttpObj.responseText);
                    //propriedade responseXML que devolve a resposta do servidor

                    var docxml = xmlHttpObj.responseText;

                    // manually parse to XML DOM object 
                    var parser = new DOMParser();

                    var xmlDoc;
                    try {
                        xmlDoc = parser.parseFromString(docxml, "text/xml");
                    } catch (e) {
                        alert("XML parsing error.");
                        return false;
                    }
                    ;


                    // lista de nós com Tag Categoria                    
                    var nodelist = xmlDoc.getElementsByTagName("categoria");

                    //alert(nodelist[0].childNodes[0].nodeValue);
                    // nodelist[0] - primeiro nó da lista (<Categoria> ???? </Categoria>)
                    // childNodes[0] - primeiro filho do nó é um nó texto  
                    // nodevalue - valor do conteudo do nó texto ( ??? )

                    var b = 0;
                    for (i = 0; i < nodelist.length; i++) {

                        for (j = i + 1; j < nodelist.length; j++) {
                            //Verifica se existem iguais
                            if (nodelist[i].childNodes[0].nodeValue == nodelist[j].childNodes[0].nodeValue) {
                                b = 1;
                            }
                        }
                        if (b == 0) {
                            var fname = nodelist[i].childNodes[0].nodeValue;

                            var opt = document.createElement('option');
                            opt.appendChild(document.createTextNode(fname));
                            var op = "<option> " + fname + "</option>";

                            // alteração do conteúdo textual do div
                            document.getElementById("selectCategoria").appendChild(opt);
                        }
                        b = 0;
                    }
                }
            }

            function escolheuCategoria( ) {

                xmlHttpObj = CreateXmlHttpRequestObject();

                var x = document.getElementById("selectCategoria").selectedIndex;
                var y = document.getElementById("selectCategoria").options;

                var concStr = y[x].text;
                if (xmlHttpObj)
                {
                    // Definição do URL para efectuar pedido HTTP - método GET
                    xmlHttpObj.open("GET", "listarLivros.php?categoria=" + concStr, true);


                    // Registo do EventHandler
                    xmlHttpObj.onreadystatechange = PreencherLivros;

                    xmlHttpObj.send(null);
                }

            }

            function PreencherLivros(   ) {

                if (xmlHttpObj.readyState == 4 && xmlHttpObj.status == 200) // resposta do servidor completa
                {
                    var docxml = xmlHttpObj.responseText;

                    // manually parse to XML DOM object 

                    var parser = new DOMParser();

                    var xmlDoc;
                    try {
                        xmlDoc = parser.parseFromString(docxml, "text/xml");
                    } catch (e) {
                        alert("XML parsing error.");
                        return false;
                    }
                    ;
                    // lista de nós com Tag Categoria                    
                    var nodelist = xmlDoc.getElementsByTagName("title");

                    var nLivros = document.getElementById("nLivros").value;
                    var tam;
                    ((nLivros < nodelist.length) ? tam = nLivros : tam = nodelist.length);
                    while (selectLivros.firstChild) {
                        selectLivros.removeChild(selectLivros.firstChild);
                    }
                    //alert(nodelist.length);
                    for (i = 0; i < tam; i++) {
                        var tname = nodelist[i].childNodes[0].nodeValue;

                        var opt = document.createElement('option');

                        opt.appendChild(document.createTextNode(tname));
                        var op = "<option> " + tname + "</option>";

                        // alteração do conteúdo textual do div
                        document.getElementById("selectLivros").appendChild(opt);
                    }
                }
            }
            function escolheuEditora( ) {

                xmlHttpObj = CreateXmlHttpRequestObject();

                var editora = document.getElementById("selectEditora").value;
                var nlivros = document.getElementById("nTopLivros").value;

                if (xmlHttpObj)
                {
                    // Definição do URL para efectuar pedido HTTP - método GET
                    xmlHttpObj.open("GET", "listarnlivros.php?neditora=" + editora + "&nlivros=" + nlivros, true);

                    // Registo do EventHandler
                    xmlHttpObj.onreadystatechange = escolheuNLivroEditora;

                    xmlHttpObj.send(null);
                }

            }

            function escolheuNLivroEditora( ) {

                if (xmlHttpObj.readyState == 4 && xmlHttpObj.status == 200) // resposta do servidor completa
                {
                    var docxml = xmlHttpObj.responseText;

                    // manually parse to XML DOM object 
                    var parser = new DOMParser();

                    var xmlDoc;
                    try {
                        xmlDoc = parser.parseFromString(docxml, "text/xml");
                    } catch (e) {
                        return false;
                    }
                    ;
                    // lista de nós com Tag Categoria                    
                    var nodelist = xmlDoc.getElementsByTagName("title");

                    var tabela = document.getElementById("idTabela");

                    var tam = nodelist.length;
                    while (tabela.firstChild) {
                        tabela.removeChild(tabela.firstChild);
                    }
                    var tr = document.createElement("tr");
                    var th = document.createElement("th");
                    var tht = document.createTextNode("Titulo do Livro");
                    th.appendChild(tht);
                    tr.appendChild(th);
                    tabela.appendChild(tr);
                    for (i = 0; i < tam; i++) {
                        var tname = nodelist[i].childNodes[0].nodeValue;

                        var tr1 = document.createElement('tr');
                        var td = document.createElement('td');
                        var link = document.createElement('a');
                        var linkfunction = "javascript:infoLivro(";
                        linkfunction += tname;
                        linkfunction += ");";
                        link.setAttribute("href", "javascript:infoLivro('" + tname + "');");
                        var titulo = document.createTextNode(tname);
                        link.appendChild(titulo);

                        //var tdt=document.createTextNode(tname);
                        td.appendChild(link);
                        tr1.appendChild(td);
                        tabela.appendChild(tr1);
                    }
                }
            }
            function infoLivro(titulo) {
                xmlHttpObj = CreateXmlHttpRequestObject();


                if (xmlHttpObj)
                {
                    // Definição do URL para efectuar pedido HTTP - método GET
                    titulo1 = encodeURIComponent(titulo.trim());
                    xmlHttpObj.open("GET", "listarinfolivros.php?titulo=" + titulo1, true);


                    // Registo do EventHandler
                    xmlHttpObj.onreadystatechange = PrintinfoLivros;

                    xmlHttpObj.send(null);
                }

            }

            function PrintinfoLivros() {
                var docxml = xmlHttpObj.responseText;

                // manually parse to XML DOM object 


                var parser = new DOMParser();

                var xmlDoc;
                //alert(docxml);
                try {
                    xmlDoc = parser.parseFromString(docxml, "text/xml");
                } catch (e) {
                    alert("XML parsing error.");
                    return false;
                }
                var info="Informações do Livro:\n";
                // lista de nós com Tag Categoria                    
                var titulo = xmlDoc.getElementsByTagName("title");
                var titulo1=titulo[0].childNodes[0].nodeValue;
                info+="Titulo:"+titulo1+"\n";
                var autor = xmlDoc.getElementsByTagName("author");
                var autor1=autor[0].childNodes[0].nodeValue;
                info+="Autor:"+autor1+"\n";
                var categoria = xmlDoc.getElementsByTagName("category");
                var categoria1=categoria[0].childNodes[0].nodeValue;
                info+="Categoria:"+categoria1+"\n";
                var ISBN = xmlDoc.getElementsByTagName("isbn");
                var ISBN1=ISBN[0].childNodes[0].nodeValue;
                info+="ISBN:"+ISBN1+"\n";
                var Ano = xmlDoc.getElementsByTagName("publicacao");
                var Ano1=Ano[0].childNodes[0].nodeValue;
                info+="Ano de Publicacao:"+Ano1+"\n";
                
                alert(info);
                
            }


        </script>
    </head>
    <body onload="carregarCategorias();">
        <form action="" method="get">
            Categorias :    
            <select id="selectCategoria" onchange="escolheuCategoria();"> </select>

            <p >
                Numero de Livros a mostrar: <input type="text" size="3" id="nLivros" value="50" onchange="escolheuCategoria();"/> 
            </p>
            <select id="selectLivros" >

            </select>
            Editora:
            <select id="selectEditora" onchange="escolheuEditora();">
                <option value="1">1</option>
                <option value="2">2</option>
            </select>

            <p>
                Numero de Livros a mostrar: <input type="text" size="3" id="nTopLivros" value="10" onchange="escolheuEditora();"/> 
            </p>
            <br>
            <table id="idTabela" border="1">

            </table>


        </form>

    </body>
</html>
