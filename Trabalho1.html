
<!DOCTYPE html>

<html>
    <head>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />

        <title> Listar Categorias</title>

        <style type="text/css">

            @import url("estilos.css");

        </style>
        <script type="text/javascript">

            // Váriavel para o objecto XMLHttpRequest
            var xmlHttpObj;

            function CreateXmlHttpRequestObject( )
            {
                // detecção do browser simplificada
                // e sem tratamento de excepções
                xmlHttpObj = null;
                if (window.XMLHttpRequest) // IE 7 e Firefox
                {
                    xmlHttpObj = new XMLHttpRequest()

                }
                else  // IE 5 e 6
                {
                    xmlHttpObj = new ActiveXObject("Microsoft.XMLHTTP")
                }
                return xmlHttpObj;
            }

            function carregarCategorias()
            {
                xmlHttpObj = CreateXmlHttpRequestObject();

                if (xmlHttpObj)
                {
                    // Definição do URL para efectuar pedido HTTP - método GET
                    xmlHttpObj.open("GET", "selectCategorias.php", true);

                    //xmlHttpObj.setRequestHeader("Content-Type:text/xml");
                    // Registo do EventHandler
                    xmlHttpObj.onreadystatechange = stateHandler;

                    xmlHttpObj.send(null);
                }

            }

            function stateHandler()
            {
                if (xmlHttpObj.readyState == 4 && xmlHttpObj.status == 200) // resposta do servidor completa
                {
                    //propriedade responseXML que devolve a resposta do servidor

                    var docxml = xmlHttpObj.responseXML;

                    // lista de nós com Tag Categoria                    
                    var nodelist = docxml.getElementsByTagName("categoria");

                    //alert(nodelist[0].childNodes[0].nodeValue);
                    // nodelist[0] - primeiro nó da lista (<Categoria> ???? </Categoria>)
                    // childNodes[0] - primeiro filho do nó é um nó texto  
                    // nodevalue - valor do conteudo do nó texto ( ??? )

                    var b = 0;
                    for (i = 0; i < nodelist.length; i++) {

                        for (j = i + 1; j < nodelist.length; j++) {
                            //Verifica se existem iguais
                            if (nodelist[i].childNodes[0].nodeValue == nodelist[j].childNodes[0].nodeValue) {
                                b = 1;
                            }
                        }
                        if (b == 0) {
                            var fname = nodelist[i].childNodes[0].nodeValue;

                            var opt = document.createElement('option');
                            opt.appendChild(document.createTextNode(fname));

                            // alteração do conteúdo textual do div
                            document.getElementById("selectCategoria").appendChild(opt);
                        }
                        b = 0;
                    }
                }
            }

            function escolheuCategoria( ) {

                xmlHttpObj = CreateXmlHttpRequestObject();

                var x = document.getElementById("selectCategoria").selectedIndex;
                var y = document.getElementById("selectCategoria").options;

                var concStr = y[x].text;
                if (xmlHttpObj)
                {
                    // Definição do URL para efectuar pedido HTTP - método GET
                    xmlHttpObj.open("GET", "listarLivros.php?categoria=" + concStr, true);


                    // Registo do EventHandler
                    xmlHttpObj.onreadystatechange = PreencherLivros;

                    xmlHttpObj.send(null);
                } else
                {
                    return new ActiveXObject("MSXML2.XMLHTTP.3.0");
                }

            }

            function PreencherLivros(   ) {

                if (xmlHttpObj.readyState == 4 && xmlHttpObj.status == 200) // resposta do servidor completa
                {
                    var docxml = xmlHttpObj.responseXML;

                    // lista de nós com Tag Categoria                    
                    var nodelist = docxml.getElementsByTagName("title");

                    var nLivros = document.getElementById("nLivros").value;
                    var tam;
                    ((nLivros < nodelist.length) ? tam = nLivros : tam = nodelist.length);
                    while (selectLivros.firstChild) {
                        selectLivros.removeChild(selectLivros.firstChild);
                    }
                    //alert(nodelist.length);
                    for (i = 0; i < tam; i++) {
                        var tname = nodelist[i].childNodes[0].nodeValue;
                        var opt = document.createElement('option');
                        opt.appendChild(document.createTextNode(tname));
                        var op = "<option> " + tname + "</option>";
                        // alteração do conteúdo textual do div
                        document.getElementById("selectLivros").appendChild(opt);
                    }
                }
            }

            //Ocorre quando a editora é alterada
            function escolheuEditora() {

                xmlHttpObj = CreateXmlHttpRequestObject();
                //Obtem a editora e o numero de livros a apresentar conforme o que o utilizador definiu
                var editora = document.getElementById("selectEditora").value;
                var nlivros = document.getElementById("nTopLivros").value;

                if (xmlHttpObj)
                {
                    // Definição do URL para efectuar pedido HTTP - método GET
                    xmlHttpObj.open("GET", "listarnlivros.php?neditora=" + editora + "&nlivros=" + nlivros, true);

                    // Registo do EventHandler
                    xmlHttpObj.onreadystatechange = escolheuNLivroEditora;

                    xmlHttpObj.send(null);
                }

            }

            //Obtem por parametro a pagina atual  
            //Obtem a resposta em XML enviada
            //Apresenta a opção para o utilizador puder escolher apresentar o resumo
            //Apresenta o n primeiros livros de cada editora

            function escolheuNLivroEditora(pag) {

                if (xmlHttpObj.readyState == 4 && xmlHttpObj.status == 200) // resposta do servidor completa
                {
                    var docxml = xmlHttpObj.responseXML;

                    // lista de nós com Tag title                   
                    var nodelist = docxml.getElementsByTagName("title");
                    //lista de nós com Tag isbn
                    var nodelist2 = docxml.getElementsByTagName("isbn");
                    //lista de nós com Tag editora
                    var editora = docxml.getElementsByTagName("editora");

                    //var isbn = docxml.getElementsByTagName("isbn");
                    //var checkcapa = document.getElementById("checkcapa");
                    //checkcapa.style.display = "inline";

                    //Obtem o checkbox para apresentar o resumo e apresenta-o
                    var checkresumo = document.getElementById("checkresumo");
                    checkresumo.style.display = "inline";
                    //var txtcapa = document.getElementById("textocapa");
                    //txtcapa.style.display = "inline";

                    //Obtem o texto para apresentar o resumo e apresenta-o
                    var txtresumo = document.getElementById("textoresumo");
                    txtresumo.style.display = "inline";

                    var editora1 = editora[0].childNodes[0].nodeValue;

                    //var isbn1 = isbn[0].childNodes[0].nodeValue;
                    //Obtem a tabela
                    var tabela = document.getElementById("idTabela");
                    //Obtem o tamanho do nodelist
                    var tam = nodelist.length;
                    //elimina todos os membros da tabela
                    while (tabela.firstChild) {
                        tabela.removeChild(tabela.firstChild);
                    }
                    //Adiciona à tabela o cabeçalho
                    var tr = document.createElement("tr");
                    var th = document.createElement("th");
                    var tht = document.createTextNode("Titulo do Livro");
                    th.appendChild(tht);
                    tr.appendChild(th);
                    tabela.appendChild(tr);
                    //Caso a pagina chegada por parametro seja null atribui o valor 1
                    if (isNaN(pag)) {
                        pag = 1;
                    }
                    //Apresenta 5 livros por casa pagina
                    //Em apresenta o nome do livro como hiperligação e acrescenta-lhe a função infolivro no caso de ser clicado
                    //Leva como parametros dessa função o seu nome,a sua editora e o seu isbn

                    for (i = pag * 5 - 5; i < pag * 5; i++) {
                        var tname = nodelist[i].childNodes[0].nodeValue;
                        var tisbn = nodelist2[i].childNodes[0].nodeValue;
                        tname = tname.trim();
                        var tr1 = document.createElement('tr');
                        var td = document.createElement('td');
                        var link = document.createElement('a');
                        link.setAttribute("href", "javascript:infoLivro('" + tname + "'," + editora1 + "," + tisbn + ");");
                        var titulo = document.createTextNode(tname);
                        link.appendChild(titulo);

                        td.appendChild(link);
                        tr1.appendChild(td);
                        tabela.appendChild(tr1);
                    }
                    //Obtem a div para acrescentar as paginas
                    var div = document.getElementById('div1');
                    //Elimina as paginas que já lá estejam
                    while (div.firstChild) {
                        div.removeChild(div.firstChild);
                    }
                    div.appendChild(document.createTextNode("Página:"));

                    //O numero de paginas é o numero de elementos a dividir por 5
                    var npags = tam / 5;

                }
                //apresenta a pagina com hiperligação para esta mesma função com a pagina em que o livro se encontra
                for (i = 0; i < npags; i++) {
                    var pag = document.createElement('a');
                    pag.setAttribute("href", "javascript:escolheuNLivroEditora(" + (i + 1) + ")");
                    var numpag = document.createTextNode(i + 1);
                    pag.appendChild(numpag);
                    div.appendChild(pag);
                }

            }


            function infoLivro(titulo, editora, isbn) {
                xmlHttpObj = CreateXmlHttpRequestObject();


                //var capa = "nao";
                var resumo = "nao";
                /*var checkcapa = document.getElementById("checkcapa");
                 if (checkcapa.checked) {
                 
                 var capa = "sim";
                 }*/
                //Obtem a checkbox checkresumo do documento e caso esteja marcada atribui sim à variavel resumo
                //A variavel resumo define que o utilizador pretende ver o resumo do livro
                var checkresumo = document.getElementById("checkresumo");
                if (checkresumo.checked) {
                    var resumo = "sim";
                }
                if (xmlHttpObj)
                {
                    // Definição do URL para efectuar pedido HTTP - método GET
                    var titulo1 = encodeURIComponent(titulo.trim());

                    xmlHttpObj.open("GET", "listarinfolivros.php?titulo=" + titulo1 + "&editora=" + editora + "&resumo=" + resumo + "&isbn=" + isbn, true);


                    // Registo do EventHandler
                    xmlHttpObj.onreadystatechange = PrintinfoLivros;
                    xmlHttpObj.send(null);
                }

            }

            function PrintinfoLivros() {

                //Obtem a resposta no formato xml com as informações do livro
                if (xmlHttpObj.readyState == 4 && xmlHttpObj.status == 200) // resposta do servidor completa
                {
                    var docxml = xmlHttpObj.responseXML;


                    var info = "Informações do Livro:\n";
                    //obtem a checkbox checkresumo do documento
                    var checkresumo = document.getElementById("checkresumo");
                    //var checkcapa=document.getElementById("checkcapa");
                    // Preenchimento da string com informações do livro 

                    var info = "<h3>Informações do Livro:</h3><br>";

                    // Preenchimento da string com informações do livro 
                    //A string sera utilizada para apresentação numa nova janela popup
                    var titulo = docxml.getElementsByTagName("title");
                    

                    var titulo1 = titulo[0].childNodes[0].nodeValue;
                    info += "<strong>Titulo:</strong>" + titulo1 + "<br>";
                    var autor = docxml.getElementsByTagName("author");

                    var autor1 = autor[0].childNodes[0].nodeValue;
                    info += "<strong>Autor:</strong>" + autor1 + "<br>";
                    var categoria = docxml.getElementsByTagName("category");

                    var categoria1 = categoria[0].childNodes[0].nodeValue;
                    info += "<strong>Categoria:</strong>" + categoria1 + "<br>";
                    var ISBN = docxml.getElementsByTagName("isbn");

                    var ISBN1 = ISBN[0].childNodes[0].nodeValue;
                    info += "<strong>ISBN:</strong>" + ISBN1 + "<br>";
                    var Ano = docxml.getElementsByTagName("publicacao");

                    var Ano1 = Ano[0].childNodes[0].nodeValue;
                    info += "<strong>Ano de Publicacao:</strong>" + Ano1 + "<br>";
                    
                    //Caso a checkbox esteja marcada adiciona o resumo mesmo que este não exista na base de dados
                    if (checkresumo.checked) {

                        var resumo = docxml.getElementsByTagName("resumo");
                        var resumo1 = resumo[0].childNodes[0].nodeValue;
                        info += "<strong>Resumo:</strong>" + resumo1 + "<br>";
                    }
                    //Definições para a nova janela popup
                    
                    var left = (screen.width * 0.5) - (200 * 0.5); //Centra no ecra no eixo y
                    var top = (screen.height * 0.5) - (100 * 0.5); //Centra no ecra no eixo x
                    //Cria uma nova janela com scroll e a posição definida anteriormente
                    novaJanela = window.open("Informações do Livro", 'Informações do livro', 'resizable=no,scroolbars=yes,top=' + top + ',left=' + left + ',width=250,height=500');
                    //Escreve na nova janela a string criada anteriormente no formato HTML
                    novaJanela.document.write(info);
                    novaJanela.focus();
                    
                    //Após apresentação do livro selecionado volta à pagina 1
                    escolheuEditora(); 
                }

            }

        </script>
    </head>

    <body onload="carregarCategorias();">

        <form action="" method="get" >
            <div id="divGeal" class="geral">
                <div id="widjet" class="box">
                    Categorias :    
                    <select id="selectCategoria" onchange="escolheuCategoria();"> </select>

                    <p >
                        Numero de Livros a mostrar: <input type="text" size="3" id="nLivros" value="50" onchange="escolheuCategoria();"/> 
                    </p>
                    <select id="selectLivros" >

                    </select>
                </div>
                <div id="Page" class="box1">
                    <br>
                    Editora:
                    <select id="selectEditora" onchange="escolheuEditora();">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                    <br>
                    <!--<input TYPE="checkbox" id="checkcapa" style="display:none" Name="Item1" Value="Capa" ><p id="textocapa" style="display:none"> Apresentar Capa</p>-->
                    <INPUT TYPE="checkbox" id="checkresumo" style="display:none" Name="Item2" Value="Resumo" ><p id="textoresumo" style="display:none">Apresentar Resumo</p>
                    <br>

                    <p>
                        Numero de Livros a mostrar na editora: <input type="text" size="3" id="nTopLivros" value="10" onchange="escolheuEditora();"/> 
                    </p>

                    <br>
                    <table id="idTabela" border="1" bgcolor="#FFFFFF">


                    </table>
                    <div id="div1">

                    </div>

                </div>

            </div>
        </form>

    </body>

</html>
